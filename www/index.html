<!doctype html>
<meta charset="utf-8">
<title>MQTT Temp Dashboard (Unified)</title>
<body style="font:16px system-ui;max-width:820px;margin:2rem auto;line-height:1.35">
  <h2>MQTT Temp Dashboard (enter host / topic)</h2>
  <div id="status">Idle</div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0">
    <label>Host (WebSockets URL)<br>
      <input id="host" style="padding:6px" placeholder="ws://192.168.1.126:9001 or wss://broker.emqx.io:8084/mqtt" value="ws://192.168.1.126:9001">
    </label>
    <label>Topic<br>
      <input id="topic" style="padding:6px" value="loranet/up/#">
    </label>
    <label>Username (optional)<br>
      <input id="user" style="padding:6px" value="Mot">
    </label>
    <label>Password (optional)<br>
      <input id="pass" style="padding:6px" value="Buster02" type="password">
    </label>
    <button id="connect" style="grid-column:1/-1;padding:8px 10px">Connect / Subscribe</button>
  </div>

  <div style="font-size:56px" id="val">--.- °C</div>
  <pre id="log" style="background:#f4f4f4;padding:10px;height:300px;overflow:auto;border:1px solid #ddd"></pre>

  <!-- MQTT over WebSockets library: try CDN, fallback to local mqtt.min.js if present -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
  (function ensureMqtt(){
    if (window.mqtt) return;
    var s = document.createElement('script');
    s.src = 'mqtt.min.js';  // place file next to this html if you want offline
    s.onerror = function(){ document.getElementById('status').textContent = 'Failed to load mqtt.min.js (CDN and local).'; };
    document.head.appendChild(s);
  })();
  </script>

  <script>
  (function(){
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");
    const valEl = document.getElementById("val");
    const hostIn = document.getElementById("host");
    const topicIn = document.getElementById("topic");
    const userIn = document.getElementById("user");
    const passIn = document.getElementById("pass");
    const btn = document.getElementById("connect");

    const log = m => { logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };

    // Allow query string: ?host=...&topic=...&user=...&pass=...
    const qs = new URLSearchParams(location.search);
    if (qs.has("host"))  hostIn.value  = qs.get("host");
    if (qs.has("topic")) topicIn.value = qs.get("topic");
    if (qs.has("user"))  userIn.value  = qs.get("user");
    if (qs.has("pass"))  passIn.value  = qs.get("pass");

    function connect(){
      if (!window.mqtt) return setTimeout(connect, 150);
      const host  = hostIn.value.trim();
      const topic = topicIn.value.trim() || "loranet/up/#";
      const user  = userIn.value;
      const pass  = passIn.value;

      statusEl.textContent = "Connecting to " + host + " …";
      log("Connecting to " + host + "  /  topic: " + topic);

      const client = mqtt.connect(host, {
        username: user || undefined,
        password: pass || undefined,
        keepalive: 30,
        reconnectPeriod: 2000,
        protocolVersion: 4,
        clean: true,
        clientId: "wsclient-" + Math.random().toString(16).slice(2,10)
      });

      client.on("connect", () => {
        statusEl.textContent = "Connected";
        log("Connected → subscribing: " + topic);
        client.subscribe(topic, err => { if (err) log("Subscribe error: " + err.message); });
      });

      client.on("message", (t, p) => {
        const s = p.toString();
        log(t + "  " + s);
        // parse c=<number> or JSON {"c": number}
        let m = s.match(/c=([-+]?\d+(?:\.\d+)?)/);
        if (!m) {
          try { const j = JSON.parse(s); if (j && typeof j.c === "number") m = [, j.c.toString()]; } catch(e){}
        }
        if (m) valEl.textContent = m[1] + " °C";
      });

      client.on("reconnect", () => { statusEl.textContent = "Reconnecting…"; log("Reconnecting…"); });
      client.on("error", e => { statusEl.textContent = "Error: " + e.message; log("Error: " + e.message); });
      client.on("close", () => log("Close"));
      client.on("offline", () => log("Offline"));
    }

    btn.addEventListener("click", connect);
  })();
  </script>
</body>
